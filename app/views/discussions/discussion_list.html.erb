<link rel="stylesheet" href="/assets/plugins/brand-buttons/brand-buttons.css">
<link rel="stylesheet" href="/assets/plugins/brand-buttons/brand-buttons-inversed.css">

<div class="breadcrumbs col-md-12">
    <div class="container">
        <h1 class="pull-left">토론방</h1>
        <ul class="pull-right breadcrumb">
            <li><a href="/">Home</a></li>
            <li>STUDY</li>
            <li class="active">토론방</li>
        </ul>
    </div><!--/container-->
</div>

<div class="container container-fluid margin-bottom-50">

    <!--토론방 개설 권한 있는 유저에게만 보이기-->
    <% if current_user.can_I_create_a_discussion? %>
        <div class="col-md-12">
            <%= button_to '토론방 개설하기', '/discussions/discussion_new', :method => :get, :class => 'btn-u btn-u-blue rounded col-md-12 col-sm-12 col-xs-12 margin-top-20 margin-bottom-20' %>
        </div>
    <% end %>

    <% @discussions.each do |discussion| %>
        <div class="col-md-6">
            <div class="news-v3 bg-color-white margin-bottom-20 margin-top-20 tag-box tag-box-v4 box-shadow shadow-effect-1">

                <div class="col-md-12 col-sm-12 col-xs-12 margin-bottom-20">
                    <h3>주제 : <%= discussion.title %></h3>
                    <ul class="list-inline posted-info">
                        <li>리더 : <span style="color: #1d78cb;"><%= discussion.user.user_name %></span> 선생님</li>
                        <li>대상학년 : <span style="color: #1d78cb;"><%= discussion.grade %></span></li>
                    </ul>
                    <ul class="list-inline posted-info">
                        <li>핵심개념 : <span style="color: #1d78cb"><%= discussion.unit_concept.name %></span></li>
                        <li>LEVEL : <span style="color: red;"><%= discussion.level %></span></li>
                    </ul>
                    <ul class="list-inline posted-info">
                        <li>토론기간 : <span style="color: #1d78cb;"><%= discussion.created_at.to_date %></span> ~ <span style="color: #1d78cb;"><%= discussion.expiration_date %></span></li>
                    </ul>

                    <ul class="post-shares">
                        <li><img src="<%= discussion.user.user_img.blank? ? '/assets/img/user_default_img.png' : discussion.user.user_img %>" class="rounded-x img-center" style="width: 40px; height: 40px; margin-bottom: 10px; background: #eee"></li>
                        <li><i class="rounded-x icon-speech" title="답변"></i><span style="background: #55acee">20</span></li>
                        <li><a href="javascript:discussionLike('<%= discussion.id %>')"><i class="rounded-x icon-heart" title="추천"></i><span style="background: #55acee"><%= discussion.like.nil? ? 0 : discussion.like %></span></a></li>
                    </ul>
                </div>

                <a href="/discussions/discussion_room/<%= discussion.id %>"><button class="btn btn-block btn-windows margin-top-20">참여하기</button></a>
            </div>
        </div>
    <% end %>
</div>

<script type="text/javascript">
    function discussionLike(discussion_id) {

        <% if current_user.nil? %>
        location = '/users/sign_in';
        <% else %>

        var url = "/discussions/" + discussion_id + "/like";

        $.ajax({
            url: url,
            type: "GET",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            datatype: "json",
            success : function(data) {
                location.reload();
            },
            error : function(){
                alert("try to again. please.");
            }
        });
        <% end %>
    }
</script>