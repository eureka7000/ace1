<div class="container-fluid" style="margin-top: 50px">

    <div class="row">
        <div class="col-xs-12 col-sm-7 col-md-7 col-lg-12">
            <h2 class="sub-header"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Concept - <%= @concept.concept_name %></h2>
        </div>
    </div>

    <div class="row">
        
        <div class="col-sm-12 col-md-12">
        
            <div class="table-responsive">
        
                <table class="table table-hover table-bordered" >
                    <thead>
                        <tr>
                            <th></th>
                            <th>Code</th>
                            <th>Unit Concept</th>
                            <th class="col-md-1">Grade</th>
                            <th class="col-md-1">Level</th>
                            <th class="col-md-1">Concepts</th>
                            <th class="col-md-1">Explanations</th>
                            <th class="col-md-1">Exercises</th>
                            <th class="col-md-1">Videos</th>
                            <th class="col-md-1">Related Concepts</th>
                            <th class="col-md-2"><i class="fa fa-cog"></i></th>
                        </tr>    
                    </thead>
                    <tbody>
                        <% @concept.unit_concepts.each do | unit_concept | %>
                        <tr>
                            <td>
                                <% if unit_concept.exercise_yn == 'concept' %>
                                <span class="label rounded-2x label-purple">Unit Concept</span>
                                <% elsif unit_concept.exercise_yn == 'exercise'  %>
                                <span class="label rounded-2x label-brown">Exercise</span>
                                <% end  %>
                            </td>
                            <td><%= unit_concept.code %></td>
                            <td><a href="/unit_concepts/<%= unit_concept.id %>"><%= unit_concept.name %></a></td>
                            <td><%= UnitConcept::GRADES[unit_concept.grade] %></td>
                            <td><% unless unit_concept.level.nil? %>
                                <% rst = 5 - unit_concept.level %>
                                <span style="color:red">
                                <% (1..unit_concept.level).each do |idx| %>
                                *
                                <% end%>
                                </span>
                                <span style="color:gray">
                                <% (1..rst).each do |idx| %>
                                *
                                <% end %>
                                </span>
                                <% end %>
                            </td>
                            <td><%= unit_concept.unit_concept_descs.where('desc_type = ?', 'unit_concept').count %>
                            <td><%= unit_concept.unit_concept_descs.where('desc_type = ?', 'explanation').count %></td>
                            <td><%= unit_concept.unit_concept_descs.where('desc_type = ?', 'exercise').count %></td>
                            <td><%= unit_concept.unit_concept_descs.where('desc_type = ?', 'video').count %></td>
                            <td><%= unit_concept.unit_concept_descs.where('desc_type = ?', 'link').count %></td>
                            <td>
                                <button class="btn btn-warning btn-xs" onclick="unitConceptModi(<%= unit_concept.id %>)"><i class="fa fa-pencil"></i> Edit</button>
                                <button class="btn btn-danger btn-xs" onclick="unitConceptDel(<%= unit_concept.id %>)"><i class="fa fa-trash-o"></i> Delete</button>
                            </td>
                        </tr>        
                        <% end %>
                    </tbody>    
                </table>   
                
                <button type="button" class="btn-u btn-primary" onclick="$('#method').val(); $('#unitConceptModal').modal();"><i class="fa fa-plus"></i> Unit Concept 및 문제 추가</button>
                <%= link_to 'Back', concepts_path, :class => 'btn-u btn-primary align-right' %>                            
             
            </div>    
            
        </div>    
        
    </div>
    
</div>

<!-- unit concept modal -->
<div class="modal fade" id="unitConceptModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel4">Unit Concept</h4>
            </div>
            <div class="modal-body">
                
                <input type="hidden" id="unit_concept_id" value="" />
                <input type="hidden" id="method" value="create" />
                
                <div class="row">
                    <div class="col-md-12">
                        <h4>구분</h4>
                        <p>
                           <select class="form-control" id="div" placeholder="구분" onchange="changedDiv(this)">
                           <option value="concept">Unit Concept</option>
                           <option value="exercise">Exercise</option>   
                           </select>
                        </p>
                    </div>
                </div>                
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Code</h4>
                        <p><input type="text" class="form-control" id="unit_concept_code" placeholder="code" /></p>
                    </div>
                    <div class="col-md-6">
                        <h4>Name</h4>
                        <p><input type="text" class="form-control" id="unit_concept_name" placeholder="name" /></p>
                    </div>
                </div>
                
                <div class="row" id="grade_div">
                    <div class="col-md-6">
                        <h4>Grade</h4>
                        <select id="grade" class="inline form-control">
                        <option value=""></option>
                        <% UnitConcept::GRADES.each_pair do |key, value| %>
                        <option value="<%= key %>"><%= value %></option>
                        <% end %>    
                        </select>    
                    </div>
                    <div class="col-md-6">
                        <h4>Level</h4>
                        <select id="level" class="inline form-control">
                        <option value=""></option>
                        <% (1..5).each do |idx|%>    
                        <option value="<%= idx %>"><%= idx %></option>
                        <% end %>
                        </select>    
                    </div>                    
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-u btn-u-default" data-dismiss="modal">닫기</button>
                <button id="unit_cocept_btn" type="button" class="btn-u btn-u-primary" onclick="insertUnitConcept()">저장</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    $('#unit_concept_name').on('keypress', function(e) {
	    if (e.which == 13) {
		    insertUnitConcept();
	    }
    });
    
    function unitConceptDel(id) {
        
        var url = "/unit_concepts/" + id
        
        $.ajax({
            url: url,
            type: "DELETE",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            dataType: "JSON",
            success: function(data) {
                location.reload();
            },
            error: function(err){}
        });                
        
    }
    
    function unitConceptModi(id) {
        
        var url = "/unit_concepts/" + id
        
        $.ajax({
            url: url,
            type: "GET",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            dataType: "JSON",
            success: function(data) {
                $('#method').val('update');
                $('#unit_concept_id').val(data.id);
                $('#unit_concept_code').val(data.code);
                $('#unit_concept_name').val(data.name);
                $('#grade').val(data.grade);
                $('#level').val(data.level);
                $('#unitConceptModal').modal('show');
            },
            error: function(err){
            }
        });        
        
    }
    
    function insertUnitConcept() {
        
        var url, data, type;
        
        $('#loading').show();
        
        if ($('#unit_concept_code').val() == '') {
            alert('Code를 입력하십시요.');
            $('#loading').hide();
            return false;
        }
        
        if ($('#unit_concept_name').val() == '') {
            alert('Name을 입력하십시요.');
            $('#loading').hide();
            return false;
        }
        
        if ($('#grade').val() == '' && $('#div').val() == 'concept') {
            alert('Grade를 선택하세요.');
            $('#loading').hide();
            return false;
        }
        
        if ($('#level').val() == '' && $('#div').val() == 'concept') {
            alert('Level을 선택하세요.');
            $('#loading').hide();
            return false;
        }

        data = {
            "unit_concept" : {
                "exercise_yn" : $('#div').val(),
                "code"       : $('#unit_concept_code').val(),
                "name"       : $('#unit_concept_name').val(),
                "grade"      : $('#grade').val(),
                "level"      : $('#level').val(),
                "concept_id" : <%= @concept.id %>
            }
        };
        
        if ($('#method').val() == 'create') {
            url = "/unit_concepts";
            type = "POST";
        } else if ( $('#method').val() == 'update' ) {
            url = '/unit_concepts/' + $('#unit_concept_id').val();
            type = "PUT";
        }

        // $.ajax({
        //     url: url,
        //     type: type,
        //     beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
        //     dataType: "JSON",
        //     data: data,
        //     success: function(data) {
        //         location.reload();
        //     },
        //     error: function(err){
        //         alert('실패했습니다.');
        //         $('#loading').hide();
        //         return false;
        //     }
        // });
        //
        // $('#unit_cocept_btn').button('reset');

    }

    function changedDiv(t) {
        if ( $(t).val() == 'exercise' ) {
            $('#grade_div').hide();
        } else {
            $('#grade_div').show();
        }
    }
    

</script>